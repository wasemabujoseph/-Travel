<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>دراستي — Course Section (توجيهي)</title>
  <meta name="description" content="دراستي - منصة متابعة مذاكرة للطلاب (توجيهي) — مواد، موارد، نماذج امتحانات، خطة مذاكرة."/>
  <style>
    /* ---------- Base (modern, professional) ---------- */
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --accent:#4f46e5;
      --accent-2:#06b6d4; --success:#16a34a; --danger:#ef4444;
      --glass: rgba(255,255,255,0.6);
      --radius:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Naskh Arabic";
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#ffffff);color:#0f172a}
    a{color:var(--accent);text-decoration:none}
    /* layout */
    .app{display:grid;grid-template-columns:320px 1fr;gap:20px;padding:22px;min-height:100vh}
    @media (max-width:900px){.app{grid-template-columns:1fr}}
    aside.sidebar{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(15,23,42,0.06);height:calc(100vh - 44px);position:sticky;top:22px;overflow:auto}
    main{min-height:60vh}
    header.site-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .brand{display:flex;flex-direction:column}
    .brand h1{margin:0;font-size:20px}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    .nav a{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;color:inherit;background:transparent;border:1px solid transparent}
    .nav a.active{background:linear-gradient(90deg, rgba(79,70,229,0.08), rgba(6,182,212,0.03));border-color:rgba(79,70,229,0.12)}
    .small{font-size:12px;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(79,70,229,0.1)}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.03);margin-bottom:12px}
    .flex{display:flex;gap:10px;align-items:center}
    input[type=text], input[type=date], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fbfdff}
    textarea{min-height:86px;resize:vertical}
    /* progress circle */
    .progress-wrap{display:flex;gap:12px;align-items:center}
    .progress-circle{width:88px;height:88px}
    .muted{color:var(--muted);font-size:13px}
    /* topics list */
    .topics{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .topic{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid #f1f5f9;background:#fbfdff}
    /* resources */
    .resources{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .resource{padding:8px;border-radius:8px;border:1px dashed #eef2ff;display:flex;justify-content:space-between;align-items:center}
    /* table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #f1f5f9;text-align:right}
    /* footer */
    footer{font-size:13px;color:var(--muted);margin-top:20px}
    /* print */
    @media print{
      body{background:#fff}
      aside.sidebar, .no-print{display:none}
      .app{grid-template-columns:1fr}
      .print-only{display:block}
    }
    .hidden{display:none}
    /* small UI niceties */
    .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;color:var(--accent);font-size:13px}
    .tag{font-size:12px;padding:4px 8px;border-radius:8px;background:#f8fafc;color:var(--muted)}
    .danger{color:var(--danger)}
    /* top controls */
    .controls{display:flex;gap:8px;align-items:center}
    .upload{display:none}
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar">
      <div class="site-top">
        <div class="brand">
          <h1 id="brandTitle">دراستي</h1>
          <p id="brandSub">قسم المواد • توجيهي</p>
        </div>
        <div class="controls">
          <button class="btn" id="exportBtn">Export</button>
          <button class="btn ghost" id="importBtn">Import</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <input id="searchBox" type="text" placeholder="ابحث عن مادة أو موضوع..." />
      </div>

      <nav class="nav" id="sidebarNav" style="margin-top:14px">
        <a href="#home" class="nav-link active" data-route="home">🏠 <span class="small">الرئيسية / Home</span></a>
        <a href="#subjects" class="nav-link" data-route="subjects">📚 <span class="small">المواد / Subjects</span></a>
        <a href="#past-papers" class="nav-link" data-route="past-papers">📝 <span class="small">نماذج الامتحانات</span></a>
        <a href="#exam-tips" class="nav-link" data-route="exam-tips">🎯 <span class="small">نصائح للامتحان</span></a>
        <a href="#planner" class="nav-link" data-route="planner">🗓️ <span class="small">الخطة / Planner</span></a>
        <a href="#resources" class="nav-link" data-route="resources">📁 <span class="small">المكتبة / Resources</span></a>
        <a href="#settings" class="nav-link" data-route="settings">⚙️ <span class="small">الإعدادات</span></a>
      </nav>

      <div style="margin-top:14px">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="muted">الحالة</div>
              <div id="summaryProgress" style="font-weight:700">0 مواد — 0% إجمالي</div>
            </div>
            <div>
              <button class="btn" id="addSubjectBtn">أضف مادة</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="small">اللغة</div>
            <div>
              <button class="btn ghost" id="langToggle">English</button>
            </div>
          </div>
          <div class="muted" style="font-size:13px">تبديل بين العربية والإنجليزية (RTL/LTR)</div>
        </div>

        <div class="card">
          <div class="muted" style="margin-bottom:8px">مصادر سريعة</div>
          <div id="quickResources" class="resources"></div>
          <div style="margin-top:8px">
            <input id="quickTitle" type="text" placeholder="عنوان المورد (مثال: ملخص الفصل 1)"/>
            <input id="quickLink" type="text" placeholder="رابط أو اسم الملف" style="margin-top:8px"/>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn" id="addQuick">أضف مورد</button>
              <button class="btn ghost" id="clearData">مسح بيانات</button>
            </div>
          </div>
        </div>

      </div>

      <footer style="margin-top:14px">
        <div class="small">ملف ثابت — البيانات محفوظة محليًا (LocalStorage)</div>
        <div class="small" style="margin-top:8px">لتشغيل مزامنة سحابية — يمكنك لاحقًا إضافة Firebase.</div>
      </footer>
    </aside>

    <main>
      <!-- Home -->
      <section id="page-home" class="page card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">مرحبًا بك في دراستي</h2>
            <div class="muted">تابع دروسك، راجع النماذج، خطط مذاكرتك — كل شيء في مكان واحد.</div>
          </div>
          <div class="flex">
            <button class="btn" id="printMonthly">طباعة تقرير شهري</button>
            <button class="btn ghost" id="openSubjects">اذهب للمواد</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:14px">
          <div>
            <div class="card">
              <h3 style="margin-top:0">آخر التحديثات</h3>
              <ul id="homeUpdates" style="margin:0;padding-left:18px;color:var(--muted)"></ul>
            </div>

            <div class="card" style="margin-top:12px">
              <h3 style="margin-top:0">المواد الأخيرة</h3>
              <div id="recentSubjects" class="resources"></div>
            </div>
          </div>

          <aside style="background:#fbfdff;padding:14px;border-radius:12px">
            <h4 style="margin:0">نصائح سريعة</h4>
            <ol style="margin-top:10px;color:var(--muted)">
              <li>قسّم المذاكرة على جلسات قصيرة (45–60 دقيقة).</li>
              <li>حل نماذج سابقة لتقوية مهارة إدارة الوقت.</li>
              <li>دوّن نقاط الضعف وكررها بانتظام.</li>
            </ol>
          </aside>
        </div>
      </section>

      <!-- Subjects -->
      <section id="page-subjects" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">المواد</h2>
            <div class="muted">أضف المواد، انشئ قائمة بالمواضيع، أرفق ملفات وفيديوهات.</div>
          </div>
          <div class="flex">
            <input id="subjectFilter" type="text" placeholder="فلترة المواد..." />
            <button class="btn" id="exportSubjects">تصدير المواد</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:12px">
          <div>
            <div id="subjectsList" class="card" style="padding:12px;min-height:300px"></div>
          </div>

          <aside class="card">
            <h3 style="margin-top:0">لوحة المادة</h3>
            <div id="subjectPanel" style="display:none">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <h4 id="panelTitle" style="margin:0">—</h4>
                  <div id="panelSubtitle" class="muted">المواضيع: 0</div>
                </div>
                <div class="progress-wrap">
                  <div id="panelProgressCircle" class="progress-circle"></div>
                </div>
              </div>

              <div style="margin-top:12px">
                <div style="display:flex;gap:8px">
                  <input id="newTopic" type="text" placeholder="أضف موضوع جديد (مثال: الكيمياء النووية)"/>
                  <button class="btn" id="addTopic">أضف</button>
                </div>

                <div class="topics" id="topicsList"></div>

                <hr style="margin:12px 0;border:none;border-top:1px solid #f1f5f9" />

                <h4 style="margin:0 0 8px 0">روابط وملفات</h4>
                <div style="display:flex;gap:8px">
                  <input id="resTitle" type="text" placeholder="عنوان المورد" />
                </div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="resLink" type="text" placeholder="رابط أو اسم الملف" />
                  <button class="btn" id="addRes">أضف مورد</button>
                </div>

                <div class="resources" id="resList"></div>

                <hr style="margin:12px 0;border:none;border-top:1px solid #f1f5f9" />
                <h4>الملاحظات و نقاط الضعف</h4>
                <textarea id="notesField" placeholder="اكتب ملاحظاتك..."></textarea>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" id="saveNotes">حفظ الملاحظات</button>
                  <button class="btn ghost" id="saveTargetDate">حفظ تاريخ الاستهداف</button>
                </div>

                <div style="margin-top:10px">
                  <label class="small">تاريخ الاستهداف للانتهاء</label>
                  <input id="targetDate" type="date"/>
                </div>
              </div>
            </div>
            <div id="noSubject" class="muted">حدد مادة من القائمة أو أنشئ مادة جديدة.</div>
          </aside>
        </div>
      </section>

      <!-- Past Papers -->
      <section id="page-past-papers" class="page hidden card">
        <h2 style="margin-top:0">نماذج الامتحانات (Past Papers)</h2>
        <div id="pastPapersList"></div>
      </section>

      <!-- Exam Tips -->
      <section id="page-exam-tips" class="page hidden card">
        <h2 style="margin-top:0">نصائح للامتحان</h2>
        <div id="tipsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>
      </section>

      <!-- Planner -->
      <section id="page-planner" class="page hidden card">
        <h2 style="margin-top:0">خطة المذاكرة وورقة التحقق الشهري</h2>
        <p class="muted">اطبع هذه الصفحة لاستخدامها كـ ورقة A3 للتقارير الشهرية.</p>
        <div style="margin-top:12px">
          <table><thead><tr><th>المادة</th><th>الموضوع</th><th>تم؟</th><th>مراجعة؟</th><th>ملاحظات</th></tr></thead>
            <tbody id="plannerTable">
              <tr><td>كيمياء</td><td>الكيمياء النووية</td><td>__</td><td>__</td><td>__</td></tr>
              <tr><td>أحياء</td><td>الجهاز العصبي</td><td>__</td><td>__</td><td>__</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Resources -->
      <section id="page-resources" class="page hidden card">
        <h2 style="margin-top:0">المكتبة المجمّعة</h2>
        <div id="resourcesGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px"></div>
      </section>

      <!-- Settings -->
      <section id="page-settings" class="page hidden card">
        <h2 style="margin-top:0">الإعدادات</h2>
        <div class="muted">النسخة الحالية تعمل محليًا. يمكنك لاحقًا إضافة مزامنة Firebase عبر تعيين مفاتيح في إعدادات المشروع.</div>
        <div style="margin-top:12px">
          <div style="display:flex;gap:8px">
            <button class="btn" id="exportAll">تنزيل نسخة احتياطية</button>
            <label class="pill">حفظ تلقائي: <input id="autosave" type="checkbox" checked style="margin-left:6px"/></label>
          </div>
        </div>
      </section>

      <footer class="no-print" style="margin-top:16px">
        <div class="muted">تم الإنشاء بواسطة دراستي — احفظ ملف <strong>index.html</strong> لتشغيله محليًا أو ارفعه إلى GitHub Pages.</div>
      </footer>

      <!-- Hidden print sheet -->
      <section class="print-only hidden" id="printSheet" style="display:none">
        <h2>تقرير تقدم المواد – شهر</h2>
        <div id="printTables"></div>
      </section>

    </main>
  </div>

  <!-- Import modal -->
  <div id="importModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center">
    <div style="background:#fff;padding:16px;border-radius:12px;max-width:640px;width:100%">
      <h3 style="margin:0">استيراد بيانات (JSON)</h3>
      <p class="muted">الصق محتوى JSON الذي صدرته مسبقًا أو اختر ملف JSON</p>
      <textarea id="importData" style="width:100%;height:160px"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
        <input type="file" id="importFile" accept=".json" />
        <button class="btn" id="doImport">استيراد</button>
        <button class="btn ghost" id="closeImport">إغلاق</button>
      </div>
    </div>
  </div>

  <script>
  /***********************
   * Single-file Study Web App
   * - Bilingual (ar/en) toggle
   * - LocalStorage persistence
   * - Pages routing via hash
   * - Subjects, topics, resources, notes
   * - Past papers, exam tips, planner templates
   ***********************/

  // ---------- Data: curated resources & tips (sample, editable) ----------
  const curatedResources = {
    "كيمياء": {
      summary: "ملخصات، فيديوهات ونماذج امتحانات كيمياء.",
      files: [
        { title: "نماذج امتحانات توجيهي - وزارة التربية (مثال PDF)", link: "https://moe.gov.jo/sites/default/files/9-1-2023.pdf" },
        { title: "Watad - أسئلة سنوات سابقة", link: "https://watad.me" }
      ],
      videos: [
        { title: "شرح توازن المعادلات - مثال", link: "https://www.youtube.com/watch?v=ysz5S6PUM-U" }
      ]
    },
    "أحياء": {
      summary: "ملخصات للجهاز العصبي، الوراثة وباقي وحدات الأحياء.",
      files: [
        { title: "نماذج امتحانات أحياء - وزارة التربية", link: "https://moe.gov.jo" }
      ],
      videos: [
        { title: "درس الجهاز العصبي - مثال", link: "https://www.youtube.com/watch?v=2Wwzmv9FF5E" }
      ]
    },
    "إنجليزي متقدم": {
      summary: "قواعد وتمارين متقدمة (Conditional, Tenses).",
      files: [
        { title: "Conditional Sentences - cheat sheet", link: "https://sharifling.wordpress.com/wp-content/uploads/2019/03/the-conditional-sentence-in-english-and-arabic.pdf" }
      ],
      videos: [
        { title: "Conditional practice", link: "https://www.youtube.com/watch?v=BqrZIhnWw9U" }
      ]
    },
    "الوزارة والامتحانات الرسمية": {
      summary: "بوابات وروابط رسمية من وزارة التربية الأردنية.",
      files: [
        { title: "بوابة وزارة التربية (Tawjihi)", link: "http://tawjihi.jo/" }
      ],
      videos: [
        { title: "قناة وزارة التربية الأردنية", link: "https://www.youtube.com" }
      ]
    }
  };

  const examTips = [
    {title: 'خطة المراجعة قبل الامتحان', body: 'خصص 3 أسابيع للمراجعة: الأسبوع الأول مراجعة شاملة، الأسبوع الثاني حل امتحانات قديمة، الأسبوع الثالث مراجعة النقاط الضعيفة.'},
    {title: 'تقنيات الإجابة', body: 'اقرأ السؤال جيدًا أولًا، ابدأ بما تعرفه لرفع الثقة، راجع الإجابات إن بقي وقت.'},
    {title: 'إدارة الوقت', body: 'قسّم وقت الامتحان حسب الوزن: الأسئلة الكبيرة خصص لها وقتًا متناسبًا.'},
    {title: 'نصائح الذاكرة', body: 'استخدم البطاقات (flashcards)، وعلّم زميلًا ما تعلمته — التعليم يعزز التذكر.'}
  ];

  // ---------- App state ----------
  const LS_KEY = 'diraasti_v2';
  let state = {
    subjects: [],            // array of {id,name,topics:[{id,title,done}],resources:[],notes,practice,target}
    quick: [],               // quick resources
    updates: [],
    lang: 'ar'
  };

  // helper
  const uid = (n=6) => 'id'+Math.random().toString(36).slice(2,2+n);

  // load/save
  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    updateSummary();
  }
  function loadState(){
    const v = localStorage.getItem(LS_KEY);
    if(v){ try{ state = JSON.parse(v); } catch(e){ console.error('parse err',e) } }
    // migrate safety
    state.subjects = state.subjects || [];
    state.quick = state.quick || [];
    state.updates = state.updates || [];
    state.lang = state.lang || 'ar';
  }

  // ---------- UI helpers ----------
  const $ = id => document.getElementById(id);
  function bySel(sel, root=document) { return root.querySelector(sel) }

  function setActiveRoute(route){
    document.querySelectorAll('.nav-link').forEach(a=>a.classList.toggle('active', a.dataset.route===route));
    document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
    const el = $('page-'+route.replace('/','-'));
    if(el) el.classList.remove('hidden');
    else $('page-home').classList.remove('hidden');
    // update document title small
    document.title = (route==='home' ? 'دراستي' : route) + ' — دراستي';
    window.scrollTo(0,0);
  }

  // ---------- rendering ----------
  function renderQuick(){
    const el = $('quickResources'); el.innerHTML='';
    if(state.quick.length===0){ el.innerHTML = '<div class="muted">لا توجد موارد سريعة</div>'; return; }
    state.quick.forEach(r=>{
      const d = document.createElement('div'); d.className='resource';
      d.innerHTML = `<div style="max-width:80%">${escapeHtml(r.title)}</div><div style="display:flex;gap:8px"><a href="${escapeAttr(r.link)}" target="_blank">فتح</a><button data-id="${r.id}" class="btn ghost del-Q">حذف</button></div>`;
      el.appendChild(d);
    });
  }

  function renderSubjectsList(filter=''){
    const el = $('subjectsList'); el.innerHTML='';
    if(state.subjects.length===0){ el.innerHTML = '<div class="muted">لا توجد مواد بعد — أضف مادة جديدة للبدء.</div>'; return; }
    state.subjects.filter(s=> s.name.includes(filter) || (s.topics||[]).some(t=>t.title.includes(filter))).forEach(s=>{
      const div = document.createElement('div'); div.className='subject';
      const done = (s.topics||[]).filter(t=>t.done).length; const total = (s.topics||[]).length;
      div.style.padding='10px'; div.style.borderRadius='10px'; div.style.marginBottom='8px'; div.style.background='#ffffff';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">${escapeHtml(s.name)}</div>
            <div class="muted" style="font-size:13px">${done} من ${total} موضوع مكتمل</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn open-sub" data-id="${s.id}">فتح</button>
            <button class="btn ghost export-sub" data-id="${s.id}">تصدير</button>
            <button class="btn" data-id="${s.id}" style="background:#ef4444" title="حذف">حذف</button>
          </div>
        </div>
      `;
      el.appendChild(div);
    });
  }

  function renderPanel(subjectId){
    const panel = $('subjectPanel'); const no = $('noSubject');
    if(!subjectId){ panel.style.display='none'; no.style.display='block'; return; }
    const s = state.subjects.find(x=>x.id===subjectId); if(!s) return;
    no.style.display='none'; panel.style.display='block';
    $('panelTitle').textContent = s.name;
    $('panelSubtitle').textContent = `المواضيع: ${s.topics.length || 0}`;
    // topics
    const topicsList = $('topicsList'); topicsList.innerHTML='';
    (s.topics||[]).forEach(t=>{
      const div = document.createElement('div'); div.className='topic';
      div.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><input type="checkbox" data-sid="${s.id}" data-tid="${t.id}" ${t.done? 'checked':''} /> <div>${escapeHtml(t.title)}</div></div>
        <div style="display:flex;gap:8px"><button data-sid="${s.id}" data-tid="${t.id}" class="btn ghost del-topic">حذف</button></div>`;
      topicsList.appendChild(div);
    });
    // resources
    const resList = $('resList'); resList.innerHTML='';
    if((s.resources||[]).length===0) resList.innerHTML = '<div class="muted">لا توجد موارد للمادة</div>';
    (s.resources||[]).forEach(r=>{
      const el = document.createElement('div'); el.className='resource';
      el.innerHTML = `<div>${escapeHtml(r.title)}</div><div style="display:flex;gap:8px"><a href="${escapeAttr(r.link)}" target="_blank">فتح</a><button data-sid="${s.id}" data-rid="${r.id}" class="btn ghost del-res">حذف</button></div>`;
      resList.appendChild(el);
    });
    // notes
    $('notesField').value = s.notes || '';
    $('targetDate').value = s.target || '';
    // progress circle
    const done = (s.topics||[]).filter(t=>t.done).length; const total = s.topics.length || 0;
    const pct = total ? Math.round(done/total*100) : 0;
    renderProgressCircle('panelProgressCircle', pct);
    // attach current subject id for actions
    $('subjectPanel').dataset.sid = s.id;
  }

  function renderRecent(){
    const r = $('recentSubjects'); r.innerHTML='';
    state.subjects.slice(0,6).forEach(s=>{
      const e = document.createElement('div'); e.className='resource'; e.style.padding='8px';
      e.innerHTML = `<div>${escapeHtml(s.name)}</div><div><button class="btn ghost open-sub" data-id="${s.id}">فتح</button></div>`;
      r.appendChild(e);
    });
  }

  function renderHomeUpdates(){
    const el = $('homeUpdates'); el.innerHTML='';
    const up = state.updates.slice(Math.max(0,state.updates.length-6));
    if(up.length===0) el.innerHTML = '<li class="muted">لا توجد تحديثات حتى الآن</li>';
    up.forEach(u=>{ const li = document.createElement('li'); li.textContent = u; el.appendChild(li) });
  }

  function renderPastPapers(){
    const el = $('pastPapersList'); el.innerHTML='';
    Object.keys(curatedResources).forEach(k=>{
      const c = curatedResources[k];
      const card = document.createElement('div'); card.className='card';
      let html = `<h3 style="margin-top:0">${escapeHtml(k)}</h3><div class="muted">${escapeHtml(c.summary)}</div>`;
      html += '<div style="margin-top:8px"><strong>Files:</strong><ul>';
      c.files.forEach(f=> html+= `<li><a href="${escapeAttr(f.link)}" target="_blank">${escapeHtml(f.title)}</a></li>`);
      html += '</ul></div>';
      html += '<div style="margin-top:6px"><strong>Videos:</strong><ul>';
      c.videos.forEach(v=> html+= `<li><a href="${escapeAttr(v.link)}" target="_blank">${escapeHtml(v.title)}</a></li>`);
      html += '</ul></div>';
      card.innerHTML = html;
      el.appendChild(card);
    });
  }

  function renderTips(){
    const el = $('tipsGrid'); el.innerHTML='';
    examTips.forEach(t=>{
      const d = document.createElement('div'); d.className='card';
      d.innerHTML = `<h4 style="margin:0">${escapeHtml(t.title)}</h4><p class="muted" style="margin-top:8px">${escapeHtml(t.body)}</p>`;
      el.appendChild(d);
    });
  }

  function renderResourcesGrid(){
    const el = $('resourcesGrid'); el.innerHTML='';
    Object.keys(curatedResources).forEach(k=>{
      const c = curatedResources[k];
      const d = document.createElement('div'); d.className='card';
      let html = `<h4>${escapeHtml(k)}</h4><div class="muted">${escapeHtml(c.summary)}</div>`;
      if(c.files && c.files.length){ html += '<div style="margin-top:8px"><strong>ملفات</strong><ul>'; c.files.forEach(f=> html += `<li><a href="${escapeAttr(f.link)}" target="_blank">${escapeHtml(f.title)}</a></li>`); html += '</ul></div>'; }
      if(c.videos && c.videos.length){ html += '<div style="margin-top:8px"><strong>فيديوهات</strong><ul>'; c.videos.forEach(v=> html += `<li><a href="${escapeAttr(v.link)}" target="_blank">${escapeHtml(v.title)}</a></li>`); html += '</ul></div>'; }
      d.innerHTML = html;
      el.appendChild(d);
    });
  }

  function renderTipsGrid(){
    // planner example already static
  }

  function updateSummary(){
    const totalSubjects = state.subjects.length;
    let totalPct = 0;
    if(totalSubjects>0){
      let sumPct=0;
      state.subjects.forEach(s=>{
        const t = s.topics||[]; const total = t.length; const done = t.filter(x=>x.done).length;
        sumPct += total? (done/total*100) : 0;
      });
      totalPct = Math.round(sumPct / totalSubjects);
    }
    $('summaryProgress').textContent = `${totalSubjects} مادة — ${totalPct}% إجمالي`;
  }

  // ---------- small utils ----------
  function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
  function escapeAttr(s){ if(!s) return ''; return String(s).replaceAll('"','&quot;') }

  // progress circle renderer
  function renderProgressCircle(containerId, pct){
    const c = $(containerId);
    const r = 36; const circ = 2*Math.PI*r; const dash = circ * (pct/100);
    c.innerHTML = `<svg viewBox="0 0 100 100" width="88" height="88" aria-hidden="true"><defs>
      <linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="${'#06b6d4'}"/><stop offset="1" stop-color="${'#4f46e5'}"/></linearGradient></defs>
      <circle cx="50" cy="50" r="${r}" fill="none" stroke="#eef2ff" stroke-width="10"></circle>
      <circle cx="50" cy="50" r="${r}" fill="none" stroke="url(#g)" stroke-width="10" stroke-dasharray="${dash} ${circ-dash}" stroke-linecap="round" transform="rotate(-90 50 50)"></circle>
      <text x="50" y="55" font-size="14" text-anchor="middle" fill="#0f172a">${pct}%</text></svg>`;
  }

  // ---------- actions ----------
  function addSubject(name){
    const s = { id: uid(8), name: name||('مادة جديدة'), topics: [], resources: [], notes: '', practice:0, target:null };
    state.subjects.unshift(s);
    state.updates.push(`أضيفت مادة: ${s.name}`);
    saveState(); renderSubjectsList(); renderRecent(); renderHomeUpdates();
  }

  function deleteSubject(id){
    state.subjects = state.subjects.filter(s=>s.id!==id);
    state.updates.push(`حُذفت مادة`); saveState(); renderSubjectsList(); renderPanel(null); renderRecent();
  }

  function openSubject(id){
    // navigate to subjects page and render panel
    location.hash = '#subjects';
    setTimeout(()=>{ renderPanel(id); }, 50);
  }

  function exportState(){
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='diraasti_export.json'; a.click(); URL.revokeObjectURL(url);
  }

  function importState(json){
    try{
      const obj = typeof json === 'string' ? JSON.parse(json) : json;
      if(obj.subjects){ state = obj; saveState(); refreshAll(); alert('تم استيراد البيانات') }
      else { alert('تنسيق غير صحيح') }
    }catch(e){ alert('خطأ في قراءة JSON') }
  }

  function refreshAll(){
    renderQuick(); renderSubjectsList($('subjectFilter').value||''); renderRecent(); renderHomeUpdates(); renderPastPapers(); renderTips(); renderResourcesGrid(); updateSummary();
  }

  // ---------- events binding ----------
  function bindEvents(){
    // nav
    document.querySelectorAll('.nav-link').forEach(a=>{
      a.addEventListener('click', (e)=>{
        const r = a.dataset.route;
        setActiveRoute(r);
      });
    });
    // route on hash
    window.addEventListener('hashchange', ()=> {
      const h = location.hash.replace('#','') || 'home'; setActiveRoute(h);
    });

    $('addSubjectBtn').addEventListener('click', ()=> {
      const name = prompt('اسم المادة'); if(!name) return; addSubject(name); refreshAll();
    });
    $('openSubjects').addEventListener('click', ()=> location.hash='#subjects');

    $('addQuick').addEventListener('click', ()=> {
      const t = $('quickTitle').value.trim(); const l = $('quickLink').value.trim();
      if(!t||!l) return alert('اكمل الحقول'); state.quick.unshift({id:uid(6), title:t, link:l}); $('quickTitle').value=''; $('quickLink').value=''; saveState(); renderQuick();
    });

    $('exportBtn').addEventListener('click', exportState);
    $('exportAll').addEventListener('click', exportState);
    $('importBtn').addEventListener('click', ()=> $('importModal').style.display='flex');
    $('closeImport').addEventListener('click', ()=> $('importModal').style.display='none');
    $('doImport').addEventListener('click', ()=> {
      const v = $('importData').value.trim(); if(!v) return alert('أدخل JSON'); importState(v); $('importModal').style.display='none';
    });
    $('importFile').addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader(); reader.onload = ()=> importState(reader.result); reader.readAsText(f);
    });

    // subject filter
    $('subjectFilter').addEventListener('input', ()=> renderSubjectsList($('subjectFilter').value.trim()));

    // subjects list delegates
    document.getElementById('subjectsList').addEventListener('click', (e)=>{
      if(e.target.classList.contains('open-sub')){ openSubject(e.target.dataset.id); renderPanel(e.target.dataset.id); }
      if(e.target.classList.contains('export-sub')){ const s = state.subjects.find(x=>x.id===e.target.dataset.id); if(!s) return; const blob = new Blob([JSON.stringify(s,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `${s.name}.json`; a.click(); URL.revokeObjectURL(url); }
      if(e.target.getAttribute('title') === 'حذف'){ if(confirm('هل تريد حذف المادة؟')){ deleteSubject(e.target.dataset.id); refreshAll(); } }
    });

    // subject panel actions
    $('addTopic').addEventListener('click', ()=> {
      const sid = $('subjectPanel').dataset.sid; if(!sid) return alert('اختر مادة'); const title = $('newTopic').value.trim(); if(!title) return alert('اكتب اسم الموضوع');
      const s = state.subjects.find(x=>x.id===sid); s.topics.push({id:uid(6), title, done:false}); $('newTopic').value=''; saveState(); renderPanel(sid); renderSubjectsList();
    });

    // topics checkbox & delete (delegate)
    $('topicsList').addEventListener('change', (e)=>{
      const cb = e.target; if(cb.tagName !== 'INPUT') return;
      const sid = cb.dataset.sid; const tid = cb.dataset.tid;
      const s = state.subjects.find(x=>x.id===sid); const t = s.topics.find(x=>x.id===tid); t.done = !!cb.checked; saveState(); renderPanel(sid); renderSubjectsList();
    });
    $('topicsList').addEventListener('click', (e)=>{
      if(e.target.classList.contains('del-topic')){ const sid = e.target.dataset.sid; const tid = e.target.dataset.tid; const s = state.subjects.find(x=>x.id===sid); s.topics = s.topics.filter(x=>x.id!==tid); saveState(); renderPanel(sid); renderSubjectsList(); }
    });

    // add resource to subject
    $('addRes').addEventListener('click', ()=> {
      const sid = $('subjectPanel').dataset.sid; if(!sid) return alert('اختر مادة'); const title = $('resTitle').value.trim(); const link = $('resLink').value.trim(); if(!title||!link) return alert('اكمل الحقول');
      const s = state.subjects.find(x=>x.id===sid); s.resources.push({id:uid(6), title, link}); $('resTitle').value=''; $('resLink').value=''; saveState(); renderPanel(sid);
    });

    // delete resource
    $('resList').addEventListener('click', (e)=>{
      if(e.target.classList.contains('del-res')){ const sid=e.target.dataset.sid; const rid=e.target.dataset.rid; const s=state.subjects.find(x=>x.id===sid); s.resources=s.resources.filter(r=>r.id!==rid); saveState(); renderPanel(sid); }
    });

    // notes save
    $('saveNotes').addEventListener('click', ()=>{
      const sid = $('subjectPanel').dataset.sid; if(!sid) return alert('اختر مادة'); const s = state.subjects.find(x=>x.id===sid); s.notes = $('notesField').value; saveState(); alert('تم حفظ الملاحظات'); renderSubjectsList();
    });

    // delete quick resource
    $('quickResources').addEventListener('click', (e)=>{
      if(e.target.classList.contains('del-Q')){ const id=e.target.dataset.id; state.quick = state.quick.filter(x=>x.id!==id); saveState(); renderQuick(); }
    });

    // clear data (danger)
    $('clearData').addEventListener('click', ()=>{
      if(!confirm('سيتم مسح كل البيانات المحلية. هل تواصل؟')) return;
      state = { subjects: [], quick: [], updates: [], lang: state.lang || 'ar' }; saveState(); refreshAll();
    });

    // search
    $('searchBox').addEventListener('input', (e)=> {
      const q = e.target.value.trim();
      renderSubjectsList(q);
    });

    // print monthly
    $('printMonthly').addEventListener('click', ()=>{
      const sheet = $('printSheet'); const container = $('printTables'); container.innerHTML='';
      state.subjects.forEach(s=>{
        const trows = (s.topics||[]).map(t=>`<tr><td style="width:35%">${escapeHtml(t.title)}</td><td>${t.done? '✅':'❌'}</td><td>${s.practice===2? '✅': s.practice===1? '🔁': ''}</td><td>${s.resources && s.resources.length? '🗂️' : ''}</td><td>${escapeHtml(s.notes||'')}</td></tr>`).join('');
        container.innerHTML += `<h3>${escapeHtml(s.name)}</h3><table style="width:100%;border-collapse:collapse"><thead style="background:#f1f5f9"><tr><th>الموضوع</th><th>تم؟</th><th>مراجعة؟</th><th>حل؟</th><th>ملاحظات</th></tr></thead><tbody>${trows}</tbody></table><br/>`;
      });
      sheet.style.display='block'; window.print(); sheet.style.display='none';
    });

    // language toggle
    $('langToggle').addEventListener('click', ()=>{
      state.lang = (state.lang === 'ar') ? 'en' : 'ar';
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      applyLanguage();
    });

    // import modal file (handled earlier)
    // export subjects quick
    $('exportSubjects').addEventListener('click', ()=> {
      const data = JSON.stringify({ subjects: state.subjects }, null, 2);
      const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'subjects.json'; a.click(); URL.revokeObjectURL(url);
    });

    // autosave checkbox
    $('autosave').addEventListener('change', (e)=> {
      // nothing complex here - saving always on actions; this toggles an indicator
      if(e.target.checked) state.updates.push('حفظ تلقائي مفعل');
      else state.updates.push('حفظ تلقائي مُعطّل');
      saveState(); renderHomeUpdates();
    });

    // import modal behavior: clicking background closes
    $('importModal').addEventListener('click', (e)=>{ if(e.target===$('importModal')) $('importModal').style.display='none'; });

  }

  // apply UI language (simple)
  function applyLanguage(){
    const L = state.lang || 'ar';
    // RTL if Arabic
    document.documentElement.dir = (L==='ar') ? 'rtl' : 'ltr';
    // change a few texts
    $('brandTitle').textContent = (L==='ar') ? 'دراستي' : 'Diraasti';
    $('brandSub').textContent = (L==='ar') ? 'قسم المواد • توجيهي' : 'Course Section • Tawjihi';
    document.querySelectorAll('.nav-link').forEach(n=>{
      const r = n.dataset.route;
      if(L==='ar'){ // revert to Arabic labels
        const map = { home:'🏠 الرئيسـية', subjects:'📚 المواد', 'past-papers':'📝 نماذج الامتحانات', 'exam-tips':'🎯 نصائح', planner:'🗓️ الخطة', resources:'📁 المكتبة', settings:'⚙️ الإعدادات' };
        n.querySelector('.small') ? n.querySelector('.small').textContent = (map[r] || r) : null;
      } else {
        const map = { home:'Home', subjects:'Subjects', 'past-papers':'Past Papers', 'exam-tips':'Exam Tips', planner:'Planner', resources:'Resources', settings:'Settings' };
        n.querySelector('.small') ? n.querySelector('.small').textContent = (map[r] || r) : null;
      }
    });
    $('langToggle').textContent = (L==='ar') ? 'English' : 'العربية';
    // tiny other texts
    if(L==='en'){
      $('addSubjectBtn').textContent = 'Add Subject'; $('exportBtn').textContent='Export'; $('importBtn').textContent='Import';
    } else {
      $('addSubjectBtn').textContent = 'أضف مادة'; $('exportBtn').textContent='Export'; $('importBtn').textContent='Import';
    }
    // save lang
    saveState();
  }

  // escapeAttr used in links
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

  // ---------- init ----------
  loadState(); bindEvents(); applyLanguage(); refreshAll(); setActiveRoute((location.hash||'#home').replace('#',''));

  // ensure sample seed if empty
  if(state.subjects.length===0){
    addSubject('كيمياء'); addSubject('أحياء'); addSubject('إنجليزي متقدم');
    // populate some topics quickly
    state.subjects[0].topics.push({id:uid(5), title:'الكيمياء النووية', done:true});
    state.subjects[0].topics.push({id:uid(5), title:'توازن المعادلات', done:false});
    state.subjects[1].topics.push({id:uid(5), title:'الجهاز العصبي', done:true});
    state.subjects[2].topics.push({id:uid(5), title:'Conditional Sentences', done:false});
    saveState(); refreshAll();
  }

  // expose for debugging
  window.Diraasti = { state, saveState, importState, exportState, addSubject };
  </script>
</body>
</html>
